import requests
import json
import pandas as pd
from tokens import token
# Base JSON payload
json_data_template = {
    'query': 'query SearchOneWayItinerariesQuery(\n  $search: SearchOnewayInput\n  $filter: ItinerariesFilterInput\n  $options: ItinerariesOptionsInput\n  $conditions: Boolean!\n) {\n  onewayItineraries(search: $search, filter: $filter, options: $options) {\n    __typename\n    ... on AppError {\n      error: message\n    }\n    ... on Itineraries {\n      server {\n        requestId\n        environment\n        packageVersion\n        serverToken\n      }\n      metadata {\n        eligibilityInformation {\n          baggageEligibilityInformation {\n            topFiveResultsBaggageEligibleForPrompt\n            numberOfBags\n          }\n          guaranteeAndRedirectsEligibilityInformation {\n            redirect {\n              anywhere\n              top10\n              isKiwiAvailable\n            }\n            guarantee {\n              anywhere\n              top10\n            }\n            combination {\n              anywhere\n              top10\n            }\n          }\n          kiwiBasicEligibility {\n            anywhere\n            top10\n          }\n          topThreeResortingOccurred\n          carriersDeeplinkEligibility\n          responseContainsKayakItinerary\n          paretoABTestEligible\n        }\n        carriers {\n          code\n          id\n        }\n        ...AirlinesFilter_data\n        ...CountriesFilter_data\n        ...WeekDaysFilter_data\n        ...TravelTip_data\n        ...Sorting_data\n        ...useSortingModes_data\n        ...PriceAlert_data\n        itinerariesCount\n        hasMorePending\n        missingProviders {\n          code\n        }\n        searchFingerprint\n        statusPerProvider {\n          provider {\n            id\n          }\n          errorHappened\n          errorMessage\n        }\n        hasTier1MarketItineraries\n        sharedItinerary {\n          __typename\n          ...TripInfo\n          ...ItineraryDebug @include(if: $conditions)\n          ... on ItineraryOneWay {\n            ... on Itinerary {\n              __isItinerary: __typename\n              __typename\n              id\n              shareId\n              price {\n                amount\n                priceBeforeDiscount\n              }\n              priceEur {\n                amount\n              }\n              provider {\n                name\n                code\n                hasHighProbabilityOfPriceChange\n                contentProvider {\n                  code\n                }\n                id\n              }\n              bagsInfo {\n                includedCheckedBags\n                includedHandBags\n                hasNoBaggageSupported\n                hasNoCheckedBaggage\n                checkedBagTiers {\n                  tierPrice {\n                    amount\n                  }\n                  bags {\n                    weight {\n                      value\n                    }\n                  }\n                }\n                handBagTiers {\n                  tierPrice {\n                    amount\n                  }\n                  bags {\n                    weight {\n                      value\n                    }\n                  }\n                }\n                includedPersonalItem\n                personalItemTiers {\n                  tierPrice {\n                    amount\n                  }\n                  bags {\n                    weight {\n                      value\n                    }\n                    height {\n                      value\n                    }\n                    width {\n                      value\n                    }\n                    length {\n                      value\n                    }\n                  }\n                }\n              }\n              bookingOptions {\n                edges {\n                  node {\n                    token\n                    bookingUrl\n                    trackingPixel\n                    itineraryProvider {\n                      code\n                      name\n                      subprovider\n                      hasHighProbabilityOfPriceChange\n                      contentProvider {\n                        code\n                      }\n                      providerCategory\n                      id\n                    }\n                    price {\n                      amount\n                    }\n                    priceEur {\n                      amount\n                    }\n                    priceLocks {\n                      priceLocksCurr {\n                        default\n                        price {\n                          amount\n                          roundedFormattedValue\n                        }\n                      }\n                      priceLocksEur {\n                        default\n                        price {\n                          amount\n                          roundedFormattedValue\n                        }\n                      }\n                    }\n                    kiwiProduct\n                    disruptionTreatment\n                    usRulesApply\n                  }\n                }\n              }\n              travelHack {\n                isTrueHiddenCity\n                isVirtualInterlining\n                isThrowawayTicket\n              }\n              duration\n              pnrCount\n            }\n            legacyId\n            sector {\n              id\n              sectorSegments {\n                guarantee\n                segment {\n                  id\n                  source {\n                    localTime\n                    utcTimeIso\n                    station {\n                      id\n                      legacyId\n                      name\n                      code\n                      type\n                      gps {\n                        lat\n                        lng\n                      }\n                      city {\n                        legacyId\n                        name\n                        id\n                      }\n                      country {\n                        code\n                        id\n                      }\n                    }\n                  }\n                  destination {\n                    localTime\n                    utcTimeIso\n                    station {\n                      id\n                      legacyId\n                      name\n                      code\n                      type\n                      gps {\n                        lat\n                        lng\n                      }\n                      city {\n                        legacyId\n                        name\n                        id\n                      }\n                      country {\n                        code\n                        id\n                      }\n                    }\n                  }\n                  duration\n                  type\n                  code\n                  carrier {\n                    id\n                    name\n                    code\n                  }\n                  operatingCarrier {\n                    id\n                    name\n                    code\n                  }\n                  cabinClass\n                  hiddenDestination {\n                    code\n                    name\n                    city {\n                      name\n                      id\n                    }\n                    country {\n                      name\n                      id\n                    }\n                    id\n                  }\n                  throwawayDestination {\n                    id\n                  }\n                }\n                layover {\n                  duration\n                  isBaggageRecheck\n                  isWalkingDistance\n                  transferDuration\n                  id\n                }\n              }\n              duration\n            }\n            lastAvailable {\n              seatsLeft\n            }\n            isRyanair\n            benefitsData {\n              automaticCheckinAvailable\n              instantChatSupportAvailable\n              disruptionProtectionAvailable\n              guaranteeAvailable\n              guaranteeFee {\n                roundedAmount\n              }\n              guaranteeFeeEur {\n                amount\n              }\n              searchReferencePrice {\n                roundedAmount\n              }\n            }\n            isAirBaggageBundleEligible\n            testEligibilityInformation {\n              paretoABTestNewItinerary\n            }\n          }\n          id\n        }\n        kayakEligibilityTest {\n          containsKayakWithNewRules\n          containsKayakWithCurrentRules\n          containsKayakAirlinesWithNewRules\n        }\n        extendedTrackingMetadata {\n          fullResponse {\n            allItineraries {\n              numberOfKiwiOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKayakOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfDeeplinkOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndKayakBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndWegoBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfWegoOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfFROnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndFRBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfU2OnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndU2BookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfVYOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndVYBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n            }\n            filteredItineraries {\n              numberOfKiwiOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKayakOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfDeeplinkOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndKayakBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndWegoBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfWegoOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfU2OnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndU2BookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfFROnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndFRBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfVYOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndVYBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n            }\n            airlineBreakdown {\n              carriers {\n                code\n                id\n              }\n              allItineraries {\n                numberOfKiwiOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKayakOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfDeeplinkOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndKayakBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndWegoBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfWegoOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfU2OnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndU2BookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfFROnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndFRBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfVYOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndVYBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n              }\n              filteredItineraries {\n                numberOfKiwiOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKayakOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfDeeplinkOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndKayakBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndWegoBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfWegoOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfU2OnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndU2BookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfFROnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndFRBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfVYOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndVYBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n              }\n            }\n          }\n          topTenInResponse {\n            allItineraries {\n              numberOfKiwiOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKayakOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfDeeplinkOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndKayakBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndWegoBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfWegoOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfU2OnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndU2BookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfFROnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndFRBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfVYOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndVYBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n            }\n            filteredItineraries {\n              numberOfKiwiOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKayakOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfDeeplinkOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndKayakBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndWegoBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfWegoOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfU2OnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndU2BookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfFROnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndFRBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfVYOnlyBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n              numberOfKiwiAndVYBookingOptionItineraries {\n                beforeMerging\n                afterMerging\n              }\n            }\n            airlineBreakdown {\n              carriers {\n                name\n                code\n                id\n              }\n              allItineraries {\n                numberOfKiwiOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKayakOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfDeeplinkOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndKayakBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndWegoBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfWegoOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfU2OnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndU2BookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfFROnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndFRBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfVYOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndVYBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n              }\n              filteredItineraries {\n                numberOfKiwiOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKayakOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfDeeplinkOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndKayakBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndDeeplinkBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndWegoBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfWegoOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfU2OnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndU2BookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfFROnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndFRBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfVYOnlyBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n                numberOfKiwiAndVYBookingOptionItineraries {\n                  beforeMerging\n                  afterMerging\n                }\n              }\n            }\n          }\n        }\n      }\n      itineraries {\n        __typename\n        ...TripInfo\n        ...ItineraryDebug @include(if: $conditions)\n        ... on ItineraryOneWay {\n          ... on Itinerary {\n            __isItinerary: __typename\n            __typename\n            id\n            shareId\n            price {\n              amount\n              priceBeforeDiscount\n            }\n            priceEur {\n              amount\n            }\n            provider {\n              name\n              code\n              hasHighProbabilityOfPriceChange\n              contentProvider {\n                code\n              }\n              id\n            }\n            bagsInfo {\n              includedCheckedBags\n              includedHandBags\n              hasNoBaggageSupported\n              hasNoCheckedBaggage\n              checkedBagTiers {\n                tierPrice {\n                  amount\n                }\n                bags {\n                  weight {\n                    value\n                  }\n                }\n              }\n              handBagTiers {\n                tierPrice {\n                  amount\n                }\n                bags {\n                  weight {\n                    value\n                  }\n                }\n              }\n              includedPersonalItem\n              personalItemTiers {\n                tierPrice {\n                  amount\n                }\n                bags {\n                  weight {\n                    value\n                  }\n                  height {\n                    value\n                  }\n                  width {\n                    value\n                  }\n                  length {\n                    value\n                  }\n                }\n              }\n            }\n            bookingOptions {\n              edges {\n                node {\n                  token\n                  bookingUrl\n                  trackingPixel\n                  itineraryProvider {\n                    code\n                    name\n                    subprovider\n                    hasHighProbabilityOfPriceChange\n                    contentProvider {\n                      code\n                    }\n                    providerCategory\n                    id\n                  }\n                  price {\n                    amount\n                  }\n                  priceEur {\n                    amount\n                  }\n                  priceLocks {\n                    priceLocksCurr {\n                      default\n                      price {\n                        amount\n                        roundedFormattedValue\n                      }\n                    }\n                    priceLocksEur {\n                      default\n                      price {\n                        amount\n                        roundedFormattedValue\n                      }\n                    }\n                  }\n                  kiwiProduct\n                  disruptionTreatment\n                  usRulesApply\n                }\n              }\n            }\n            travelHack {\n              isTrueHiddenCity\n              isVirtualInterlining\n              isThrowawayTicket\n            }\n            duration\n            pnrCount\n          }\n          legacyId\n          sector {\n            id\n            sectorSegments {\n              guarantee\n              segment {\n                id\n                source {\n                  localTime\n                  utcTimeIso\n                  station {\n                    id\n                    legacyId\n                    name\n                    code\n                    type\n                    gps {\n                      lat\n                      lng\n                    }\n                    city {\n                      legacyId\n                      name\n                      id\n                    }\n                    country {\n                      code\n                      id\n                    }\n                  }\n                }\n                destination {\n                  localTime\n                  utcTimeIso\n                  station {\n                    id\n                    legacyId\n                    name\n                    code\n                    type\n                    gps {\n                      lat\n                      lng\n                    }\n                    city {\n                      legacyId\n                      name\n                      id\n                    }\n                    country {\n                      code\n                      id\n                    }\n                  }\n                }\n                duration\n                type\n                code\n                carrier {\n                  id\n                  name\n                  code\n                }\n                operatingCarrier {\n                  id\n                  name\n                  code\n                }\n                cabinClass\n                hiddenDestination {\n                  code\n                  name\n                  city {\n                    name\n                    id\n                  }\n                  country {\n                    name\n                    id\n                  }\n                  id\n                }\n                throwawayDestination {\n                  id\n                }\n              }\n              layover {\n                duration\n                isBaggageRecheck\n                isWalkingDistance\n                transferDuration\n                id\n              }\n            }\n            duration\n          }\n          lastAvailable {\n            seatsLeft\n          }\n          isRyanair\n          benefitsData {\n            automaticCheckinAvailable\n            instantChatSupportAvailable\n            disruptionProtectionAvailable\n            guaranteeAvailable\n            guaranteeFee {\n              roundedAmount\n            }\n            guaranteeFeeEur {\n              amount\n            }\n            searchReferencePrice {\n              roundedAmount\n            }\n          }\n          isAirBaggageBundleEligible\n          testEligibilityInformation {\n            paretoABTestNewItinerary\n          }\n        }\n        id\n      }\n    }\n  }\n}\n\nfragment AirlinesFilter_data on ItinerariesMetadata {\n  carriers {\n    id\n    code\n    name\n  }\n}\n\nfragment CountriesFilter_data on ItinerariesMetadata {\n  stopoverCountries {\n    code\n    name\n    id\n  }\n}\n\nfragment ItineraryDebug on Itinerary {\n  __isItinerary: __typename\n  itineraryDebugData {\n    debug\n  }\n}\n\nfragment PrebookingStation on Station {\n  code\n  type\n  city {\n    name\n    id\n  }\n}\n\nfragment PriceAlert_data on ItinerariesMetadata {\n  priceAlertExists\n  existingPriceAlert {\n    id\n  }\n  searchFingerprint\n  hasMorePending\n  priceAlertsTopResults {\n    best {\n      price {\n        amount\n      }\n    }\n    cheapest {\n      price {\n        amount\n      }\n    }\n    fastest {\n      price {\n        amount\n      }\n    }\n    sourceTakeoffAsc {\n      price {\n        amount\n      }\n    }\n    destinationLandingAsc {\n      price {\n        amount\n      }\n    }\n  }\n}\n\nfragment Sorting_data on ItinerariesMetadata {\n  topResults {\n    best {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    cheapest {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    fastest {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    sourceTakeoffAsc {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    destinationLandingAsc {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n  }\n}\n\nfragment TravelTip_data on ItinerariesMetadata {\n  travelTips {\n    __typename\n    ... on TravelTipRadiusMoney {\n      radius\n      params {\n        name\n        value\n      }\n      savingMoney: saving {\n        amount\n        currency {\n          id\n          code\n          name\n        }\n        formattedValue\n      }\n      location {\n        __typename\n        id\n        legacyId\n        name\n        slug\n      }\n    }\n    ... on TravelTipRadiusTime {\n      radius\n      params {\n        name\n        value\n      }\n      saving\n      location {\n        __typename\n        id\n        legacyId\n        name\n        slug\n      }\n    }\n    ... on TravelTipRadiusSome {\n      radius\n      params {\n        name\n        value\n      }\n      location {\n        __typename\n        id\n        legacyId\n        name\n        slug\n      }\n    }\n    ... on TravelTipDateMoney {\n      dates {\n        start\n        end\n      }\n      params {\n        name\n        value\n      }\n      savingMoney: saving {\n        amount\n        currency {\n          id\n          code\n          name\n        }\n        formattedValue\n      }\n    }\n    ... on TravelTipDateTime {\n      dates {\n        start\n        end\n      }\n      params {\n        name\n        value\n      }\n      saving\n    }\n    ... on TravelTipDateSome {\n      dates {\n        start\n        end\n      }\n      params {\n        name\n        value\n      }\n    }\n    ... on TravelTipExtend {\n      destination {\n        __typename\n        id\n        name\n        slug\n      }\n      locations {\n        __typename\n        id\n        name\n        slug\n      }\n      price {\n        amount\n        currency {\n          id\n          code\n          name\n        }\n        formattedValue\n      }\n    }\n  }\n}\n\nfragment TripInfo on Itinerary {\n  __isItinerary: __typename\n  ... on ItineraryOneWay {\n    sector {\n      sectorSegments {\n        segment {\n          source {\n            station {\n              ...PrebookingStation\n              id\n            }\n            localTime\n          }\n          destination {\n            station {\n              ...PrebookingStation\n              id\n            }\n          }\n          id\n        }\n      }\n      id\n    }\n  }\n  ... on ItineraryReturn {\n    outbound {\n      sectorSegments {\n        segment {\n          source {\n            station {\n              ...PrebookingStation\n              id\n            }\n            localTime\n          }\n          destination {\n            station {\n              ...PrebookingStation\n              id\n            }\n          }\n          id\n        }\n      }\n      id\n    }\n    inbound {\n      sectorSegments {\n        segment {\n          destination {\n            station {\n              ...PrebookingStation\n              id\n            }\n            localTime\n          }\n          id\n        }\n      }\n      id\n    }\n  }\n  ... on ItineraryMulticity {\n    sectors {\n      sectorSegments {\n        segment {\n          source {\n            station {\n              ...PrebookingStation\n              id\n            }\n            localTime\n          }\n          destination {\n            station {\n              ...PrebookingStation\n              id\n            }\n            localTime\n          }\n          id\n        }\n      }\n      id\n    }\n  }\n}\n\nfragment WeekDaysFilter_data on ItinerariesMetadata {\n  inboundDays\n  outboundDays\n}\n\nfragment useSortingModes_data on ItinerariesMetadata {\n  topResults {\n    best {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    cheapest {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    fastest {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    sourceTakeoffAsc {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n    destinationLandingAsc {\n      __typename\n      duration\n      price {\n        amount\n      }\n      id\n    }\n  }\n}\n',  # Replace with actual query if needed
    'variables': {
        'search': {
            'itinerary': {
                'source': {'ids': ['City:muscat_om']},
                'destination': {'ids': ['City:kuwait-city_kw']},
                'outboundDepartureDate': {
                    'start': '2025-07-26T00:00:00',
                    'end': '2025-07-26T23:59:59',
                },
            },
            'passengers': {
                'adults': 1,
                'children': 0,
                'infants': 0,
                'adultsHoldBags': [0],
                'adultsHandBags': [0],
                'childrenHoldBags': [],
                'childrenHandBags': [],
            },
            'cabinClass': {
                'cabinClass': 'ECONOMY',
                'applyMixedClasses': False,
            },
        },
        'filter': {
            'allowChangeInboundDestination': True,
            'allowChangeInboundSource': True,
            'allowDifferentStationConnection': True,
            'enableSelfTransfer': True,
            'enableThrowAwayTicketing': True,
            'enableTrueHiddenCity': True,
            'transportTypes': ['FLIGHT'],
            'contentProviders': ['KIWI', 'FRESH'],
            'flightsApiLimit': 25,
            'limit': 10,
        },
        'options': {
            'sortBy': 'QUALITY',
            'mergePriceDiffRule': 'INCREASED',
            'currency': 'aed',
            'apiUrl': None,
            'locale': 'en',
            'market': 'ae',
            'partner': 'skypicker',
            'partnerMarket': 'xx',
            'affilID': 'skypicker',
            'storeSearch': False,
            'searchStrategy': 'REDUCED',
            'abTestInput': {
                'priceElasticityGuarantee': 'DISABLE',
                'baggageProtectionBundle': 'ENABLE',
                'paretoProtectVanilla': 'ENABLE',
                'kiwiBasicThirdIteration': 'C',
                'kayakWithoutBags': 'DISABLE',
                'carriersDeeplinkResultsEnable': True,
                'carriersDeeplinkOnSEMEnable': True,
            },
            'serverToken': None,
            'searchSessionId': None,
        },
        'conditions': False,
    },
}

# Params
params = {
    'featureName': 'SearchOneWayItinerariesQuery',
}

# Proxy setup

proxyModeUrl = f"http://{token}:@proxy.scrape.do:8080"
proxies = {
    "http": proxyModeUrl,
    "https": proxyModeUrl,
}

def format_duration(seconds):
    if not seconds:
        return None
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    return f"{hours} hr {minutes} min"

session = requests.Session()

# Loop over limits
start = 10
end = 200
step = 10

prev_len = None
best_response = None  # Store best response (most itineraries)

for limit in range(start, end + 1, step):
    print(f"\nFetching data for limit={limit}...")
    json_data = json.loads(json.dumps(json_data_template))
    json_data["variables"]["filter"]["limit"] = limit

    try:
        response = session.post(
            'https://api.skypicker.com/umbrella/v2/graphql',
            params=params,
            proxies=proxies,
            json=json_data,
            verify=False,
            headers={
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36",
                "Accept-Encoding": "gzip, deflate, br",
                "Accept-Language": "en-US,en;q=0.9",
                "Referer": "https://www.google.com/ ",
            }
        )
        response.raise_for_status()
        data = response.json()
        itineraries = data.get("data", {}).get("onewayItineraries", {}).get("itineraries", [])
        current_len = len(itineraries)

        print(f"Found {current_len} flights at limit={limit}")

        # Keep the best (largest) batch
        if best_response is None or current_len > prev_len:
            best_response = data
            print("New best response updated.")

        if prev_len is not None and current_len == prev_len:
            print("No more new results. Breaking loop.")
            break

        prev_len = current_len

    except Exception as e:
        print(f"Error fetching limit={limit}: {e}")
        continue

    # time.sleep(1)

# Process only the best (largest) response
flights_list = []
if best_response:
    itineraries = best_response.get("data", {}).get("onewayItineraries", {}).get("itineraries", [])

    for itinerary in itineraries:
        segments = itinerary.get("sector", {}).get("sectorSegments", [])
        is_direct = len(segments) == 1

        stops = []
        layovers = []

        for i in range(len(segments) - 1):
            dest = segments[i]["segment"]["destination"]["station"]["city"]["name"]
            stops.append(dest)
            layover = segments[i].get("layover")
            layovers.append(layover)

        first_segment = segments[0]["segment"]
        last_segment = segments[-1]["segment"]

        # Extract local times
        departure_local_time = first_segment["source"]["localTime"]
        arrival_local_time = last_segment["destination"]["localTime"]

        flight_info = {
            "url" : "https://www.kiwi.com/en/search/results/muscat-oman/kuwait-city-kuwait/2025-07-26/no-return",
            "source": first_segment["source"]["station"]["code"],
            "destination": last_segment["destination"]["station"]["code"],
            "flight_type": "One_Way",
            "airline_name": first_segment["carrier"]["name"],
            "airline_price": float(itinerary["price"]["amount"]),
            "currency" : "AED",
            "journey_time": format_duration(itinerary.get("duration")),
            "is_direct_flight": is_direct,
            "class": first_segment["cabinClass"].capitalize(),
            "stops": ", ".join(stops) if stops else None,
            "departure_time": departure_local_time,
            "arrival_time": arrival_local_time
        }
        flights_list.append(flight_info)

    print(f"\nTotal flights extracted: {len(flights_list)}")

    # Export to Excel
    df = pd.DataFrame(flights_list)
    df=df.fillna("N/A")
    df.to_excel('kiwi_16_07.xlsx', index=False)
    print("Saved to kiwi_16_07.xlsx")

else:
    print("No valid response was received.")